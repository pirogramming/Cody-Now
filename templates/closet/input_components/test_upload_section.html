{% load static %}
<div id="upload-and-result-section">
  <div class="upload-section" id="upload-section">
    <h2>ì˜· ì‚¬ì§„ì„ ì˜¬ë¦¬ë©´ <br />AIê°€ ë‚˜ë¨¸ì§€ ì°©ì¥ì„ ì¶”ì²œí•´ì¤˜ìš”.</h2>
    
    <!-- ë¯¸ë¦¬ë³´ê¸° ë° ì—…ë¡œë“œ ì„¹ì…˜ -->
    <div class="preview-container" id="preview-container">
      <img id="preview-image" class="preview-image" {% if outfit.image %} src="{{ outfit.image.url }}" style="display: block;" {% else %} style="display: none;" {% endif %} />
      <img
        id="image-preview-icon"
        src="{% static 'images/image_upload.svg' %}"
        alt="Upload Icon"
      />
      <div class="upload-controls" id="upload-controls">
        <form method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <div id="file-input-container">
            <input
              type="file"
              name="image"
              id="id_image"
              accept="image/*"
              onchange="previewImage(this);"
            />
            <label for="id_image" id="custom-upload-btn"
              >ì´ë¯¸ì§€ ì—…ë¡œë“œí•˜ê¸°</label
            >
            <button
              type="submit"
              class="upload-btn"
              id="upload-btn"
              style="display: none"
            >
              AI ì˜· ë¶„ì„ ê²°ê³¼ í™•ì¸í•˜ê¸°
            </button>
            <script>
              document.getElementById("ai-analysis-btn").addEventListener("click", function() {
                  openSlide();  // âœ… ë²„íŠ¼ í´ë¦­ ì‹œ openSlide ì‹¤í–‰
              });
            </script>
          </div>
        </form>
        <div class="result-section" id="result-section" {% if ai_result %} style="display: block;" {% else %} style="display: none" {% endif %}>
          <div class="cody-loading" id="cody-loading" style="display: none">
            <div class="spinner"></div>
            <span>ì½”ë””ë¥¼ ì¶”ì²œì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</span>
          </div>

          <pre id="result"></pre>
          
          <!-- <a href="{% url 'user:login' %}">
            <button id="get-cody" style="display: none">
              ì½”ë”” ì¶”ì²œë°›ê¸°
            </button>
          </a> -->
          
          <!-- ìˆ˜ì •í•˜ê¸° -->

          
        </div>

      </div>
    </div>
    <div id="product-comment">
      <pre id="product-comment-tag"></pre>
    </div>
    <!-- ì´ë¯¸ì§€ ë¶„ì„ ì¤‘ ë¡œë”© í‘œì‹œ -->
    <div class="loading" id="loading" style="display: none">
      <div class="spinner"></div>
      <span>ì´ë¯¸ì§€ë¥¼ ë¶„ì„ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</span>
    </div>
    <div id=show-category-slide-section>
      <a href="{% url 'user:login' %}">
        <button id="show-category-slide" style="display: none" onclick="redirectToLogin()">
          ë‚˜ë§Œì˜ ì˜·ì¥ì— ì €ì¥í•˜ê¸°
        </button>
      </a>
      <a href="{% url 'user:login' %}">
        <button id="get-cody" style="display: none">
          ì½”ë”” ì¶”ì²œë°›ê¸°
        </button>
      </a>
    </div>
  </div>
</div>
<hr />
<script>
  document.getElementById("upload-form").addEventListener("submit", function(event) {
      event.preventDefault();
      
      let formData = new FormData();
      let imageFile = document.getElementById("image-input").files[0];
  
      formData.append("image", imageFile);
  
      fetch("/test_upload_outfit/", {
          method: "POST",
          body: formData
      })
      .then(response => response.json())
      .then(data => {
          if (data.message) {
              document.getElementById("result").innerHTML = `
                  <h2>AI ë¶„ì„ ê²°ê³¼</h2>
                  <p><strong>ë””ìì¸ ìŠ¤íƒ€ì¼:</strong> ${data.data.design_style}</p>
                  <p><strong>ì¹´í…Œê³ ë¦¬:</strong> ${data.data.category}</p>
                  <p><strong>ìƒ‰ìƒ:</strong> ${data.data.color}</p>
                  <p><strong>ì†Œì¬:</strong> ${data.data.material}</p>
                  <p><strong>ê³„ì ˆ:</strong> ${data.data.season}</p>
                  <p><strong>ê°€ê²©:</strong> ${data.data.price}</p>
              `;
          } else {
              document.getElementById("result").innerHTML = `<p>ì˜¤ë¥˜ ë°œìƒ: ${data.error}</p>`;
          }
      })
      .catch(error => console.error("Error:", error));
  });



    function openSlide() {
        console.log("ğŸ“¸ openSlide í•¨ìˆ˜ ì‹¤í–‰ë¨!"); 
    }


</script>

<style>
  #edit-result-btn{
    display: none;
  }

    /* ì „ì²´ ì»¨í…Œì´ë„ˆ */
    #upload-and-result-section {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
   
    }
    .preview-container {
    display: flex;

    text-align: center;
    margin-bottom: 15px;
    }
    .upload-section{
        display: flex;
        flex-direction: column;
        flex-grow: 1; /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
        gap: 10px;
        padding: 15px;
        background: white;
        border-radius: 10px;
    
        box-sizing: border-box;
    }
    .result-section {
        display: flex;
        flex-direction: column;
        flex-grow: 1; /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
        gap: 10px;
        padding: 15px;
        background: white;
        border-radius: 10px;
        width: 350px;
        box-sizing: border-box;
    }
    .product-comment {
        word-wrap: break-word;  /* ê¸´ ë‹¨ì–´ê°€ ìˆìœ¼ë©´ ì¤„ë°”ê¿ˆ */
        word-break: break-word; /* ìë™ ì¤„ë°”ê¿ˆ */
        overflow-wrap: break-word; /* ì¤„ë°”ê¿ˆ ìœ ì§€ */
        white-space: normal;  /* ê¸°ì¡´ nowrapì´ ì ìš©ë˜ì—ˆì„ ê°€ëŠ¥ì„± ì°¨ë‹¨ */
        max-width: 100%;  /* ë¶€ëª¨ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ë„˜ì¹˜ì§€ ì•Šë„ë¡ ì„¤ì • */
        flex-direction: column;
    }
    .result-section{
        width: 100%;
    }



    /* ì¹´í…Œê³ ë¦¬ ì •ë³´ */
    .result-section {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }

    .result-section p {
        font-size: 14px;
        display: flex;
        
    }

    .result-section .bold {
        font-weight: bold;
        margin-right: 8px;
    }



    /* ì½”ë”” ì¶”ì²œë°›ê¸° ë²„íŠ¼ê³¼ ì¶”ì²œ ë¡œë”©ë°”ë¥¼ í™”ë©´ í•˜ë‹¨ ì¤‘ì•™ì— ê³ ì • */
    /* #get-cody, #cody-loading {
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3;  
    }
    #get-cody:disabled {
    display: none;
    } */


     /* ì½”ë”” ì¶”ì²œë°›ê¸° ë²„íŠ¼ê³¼ ì¶”ì²œ ë¡œë”©ë°”ë¥¼ í™”ë©´ í•˜ë‹¨ ì¤‘ì•™ì— ê³ ì • */
    #get-cody {
    margin-top: 10px;
    display: flex; /* í”Œë ‰ìŠ¤ë°•ìŠ¤ ì‚¬ìš© */
    align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
    justify-content: center;
    width: 10.5625rem;
    height: 2.3125rem;
    background-color: black;
    color: white;
    border-radius: 20px;
    cursor: pointer;
    font-family: Inter;
    font-size: 0.75rem;
    font-style: normal;
    font-weight: 600;
    line-height: normal;
    }
    #cody-loading{  
    margin-top: 10px;
    display: flex; /* í”Œë ‰ìŠ¤ë°•ìŠ¤ ì‚¬ìš© */
    align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
    justify-content: center;

    }
    #get-cody:disabled {
      display: none;
    }

    

</style>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const urlParams = new URLSearchParams(window.location.search);
    const outfitId = urlParams.get("id");

    if (outfitId) {
        fetchAIResult(outfitId);
    }
});

function fetchAIResult(outfitId) {
    fetch(`/api/get_ai_result/${outfitId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.warn("ğŸš¨ AI ë¶„ì„ ê²°ê³¼ ì—†ìŒ:", data.error);
                return;
            }

            // âœ… ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
            const previewImage = document.getElementById("preview-image");
            previewImage.src = data.image_url;
            previewImage.style.display = "block";

            // âœ… AI ë¶„ì„ ê²°ê³¼ ì—…ë°ì´íŠ¸
            const resultSection = document.getElementById("result-section");
            const resultText = document.getElementById("result");
            resultText.textContent = data.analysis_result;
            resultSection.style.display = "block";
        })
        .catch(error => console.error("ğŸš¨ AI ë¶„ì„ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error));
}

</script>