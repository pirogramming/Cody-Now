{% load static %}
<style>
  {% comment %} ì˜¤ë²„ë ˆì´ {% endcomment %}
  .slide-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5); /* ê²€ì • ë°˜íˆ¬ëª… */
    display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
    z-index: 99; /* ìŠ¬ë¼ì´ë“œë³´ë‹¤ ë‚®ì§€ë§Œ, ë‹¤ë¥¸ ìš”ì†Œë³´ë‹¤ëŠ” ë†’ê²Œ */
  }

 .slide-container {
  position: fixed;
  bottom: -100%;
  left: 50%; /* ì™¼ìª½ì„ í™”ë©´ì˜ 50%ë¡œ ì§€ì • */
  transform: translateX(-50%); /* ì¤‘ì•™ ì •ë ¬ */
  width: 100%;
  max-width: 600px;
  background: white;
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
  transition: bottom 0.3s ease-in-out;
  border-radius: 10px 10px 0 0;
  z-index: 100;
  height: 70%;
  display: flex;
  flex-direction: column;
  align-items: center;
  display:none;
}
.show-weather-slide {
  display: flex !important; /* ìŠ¬ë¼ì´ë“œê°€ ì—´ë¦´ ë•Œ flexë¡œ ë³€ê²½ */
  bottom: 0 !important;
}
.search-header{
  font:var( --font-title-1);
  color:var( --color-gray-darkest);
  width:100%;
}
  input {
    border: none;
    background: #f2f2f2;
    padding-inline: 1rem;
    font-size: 1rem;
    width: 80%;
  }
  .slide-content {
    padding: 10px;
    width: 90%;
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  .search-container {
    border-radius: 0.625rem;
    background: #f2f2f2;
    height: 3rem;
    display: flex;
    align-items: center;
    padding-inline: 1rem;
    width: 80%;
    margin-block:1rem;
  }
  .search-result {
    width: 95%;
    padding: 0.7rem;
    margin-top: 2rem;
    display: none;
font-size: 1.25rem;
font-style: normal;
font-weight: 600;
line-height: 90%; /* 1.125rem */
 

  }
  .search-wrapper{
    display: flex;
    align-items: center;
  }
  .search-btn {
    height:3rem;
    background-color: black;
    color: white;
    border-radius: 10px;
    width: 20%;
    margin-left:3px;
  }
  .searchAddress{
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .setLocation-btn{
    height:2.5rem;
    background-color: black;
    color: white;
    border-radius: 10px;
    width: 5rem;
    margin-left:3px;
  }
  .show-slide {
    bottom: 0 !important;
  }
  .location-btn {
    border-radius: 1.25rem;
    border: 1px solid #d9d9d9;
    background: #fff;
    width: 80%;
    height: 2.3125rem;
  }
  span {
    margin-inline: 1rem;
  }
  .search-wrapper {
    display: flex;
    width: 100%;

  }
  .close-arrow{
    margin-block:1rem;
    cursor:pointer;
  }
  .searchContainer{
    display:none;
  }
</style>

<div id="slide-overlay" class="slide-overlay" onclick="closeSlide()"></div>

<div id="slide-container" class="slide-container">
  <img class="close-arrow" onclick="closeSlideWeather() "src="{% static 'images/bxs_down-arrow.svg'%}"/>
  <div class="slide-content">
    <div class="search-header">
      <div>ë‚´ ìœ„ì¹˜ ì„ íƒ</div>
    </div>
    <div class="search-wrapper">
      <div class="search-container">
        <img src="{% static 'images/search_icon.svg' %}" />
        <input type="text" id="citySearch" placeholder="ì§€ì—­ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì ì›ë™, ê°•ë‚¨êµ¬)" />
      </div>
      <button onclick="searchCity()" class="search-btn">ê²€ìƒ‰</button>
    </div>
    <button onclick="getCurrentLocationAndUpdateSession()" class="location-btn" title="í˜„ì¬ ìœ„ì¹˜ ë‚ ì”¨ ë³´ê¸°">
      <i class="fas fa-location-arrow"><span>í˜„ì¬ ìœ„ì¹˜ë¡œ ì„¤ì •í•˜ê¸°<span></i>
    </button>
    <div id="search-result" class="search-result"></div>
  </div>
</div>

<script>
  let touchStartY = 0;
let touchEndY = 0;

document.getElementById("slide-container").addEventListener("touchstart", function (event) {
    touchStartY = event.touches[0].clientY;
}, false);

document.getElementById("slide-container").addEventListener("touchmove", function (event) {
    touchEndY = event.touches[0].clientY;
}, false);

document.getElementById("slide-container").addEventListener("touchend", function () {
    if (touchEndY - touchStartY > 100) { // 100px ì´ìƒ ì•„ë˜ë¡œ ìŠ¤ì™€ì´í”„ ì‹œ ë‹«ê¸°
        closeSlideWeather()
    }
}, false);

function openSlideWeather() {
  const slideContainer = document.getElementById("slide-container");
  const overlay = document.getElementById("slide-overlay"); // ë°°ê²½ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
  
  overlay.style.display = "block"; // ë°°ê²½ í™œì„±í™”
  slideContainer.style.display = "flex"; // ìŠ¬ë¼ì´ë“œ í‘œì‹œ
  setTimeout(() => {
    slideContainer.classList.add("show-weather-slide"); // ì• ë‹ˆë©”ì´ì…˜ ì ìš©
  }, 10);
}

function closeSlideWeather() {
  const slideContainer = document.getElementById("slide-container");

  const overlay = document.getElementById("slide-overlay"); // ë°°ê²½ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°

  slideContainer.classList.remove("show-weather-slide");
  
  setTimeout(() => {
    slideContainer.style.display = "none"; // ë‹«ì„ ë•Œ ì™„ì „íˆ ìˆ¨ê¹€
    overlay.style.display = "none"; // ë°°ê²½ ìˆ¨ê¸°ê¸°
  }, 300); // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì •
}
function searchCity() {
    const address = document.getElementById("citySearch").value;
    if (!address) return alert("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”!");

    fetch(`/api/weather/?address=${encodeURIComponent(address)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                const formattedAddress = data.weather.formatted_address;
                displayWeather(data);
                suggestOutfit(data.outfit_recommendation);

                // ğŸ”¥ sessionStorageì— ê²€ìƒ‰í•œ ìœ„ì¹˜ ì €ì¥
                sessionStorage.setItem("savedLocation", formattedAddress);

                showSearchResult(formattedAddress, data.weather.weather[0].icon, data.weather.main.temp, data);
            }
        })
        .catch(error => {
            console.error("ë‚ ì”¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", error);
            alert("ë‚ ì”¨ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        });
}



function slide_weather_fetchWeatherData(lat, lon) {
    console.log("slide_weather_fetchWeatherData í˜¸ì¶œë¨", lat, lon);

    fetch(`/api/weather/?lat=${lat}&lon=${lon}`)
      .then((response) => response.json())
      .then((data) => {
        console.log("ìŠ¬ë¼ì´ë“œ API ì‘ë‹µ:", data);

        if (data.error) {
          console.error("Error:", data.error);
        } else {
          console.log("ìŠ¬ë¼ì´ë“œì—ì„œ displayWeather í˜¸ì¶œë¨");
          displayWeather(data);

          console.log("ìŠ¬ë¼ì´ë“œì—ì„œ suggestOutfit í˜¸ì¶œë¨");
          suggestOutfit(data.outfit_recommendation);
          
          if (data.forecast && data.forecast.list) {
            console.log("ìŠ¬ë¼ì´ë“œì—ì„œ displayForecast í˜¸ì¶œë¨");
            displayForecast(data);
          } else {
            console.error("Forecast ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          }
        }
      })
      .catch((error) => {
        console.error("ë‚ ì”¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", error);
      });
}
function slide_weather_getCurrentLocation() {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        console.log("ìŠ¬ë¼ì´ë“œì—ì„œ ìœ„ì¹˜ ê°€ì ¸ì˜´", lat, lon);
        slide_weather_fetchWeatherData(lat, lon);
      },
      () => {
        alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
    );
}



// âœ… showSearchResult()ì—ì„œ ë°ì´í„° ì „ë‹¬
function showSearchResult(address, icon, temp, data) {
    console.log("showSearchResult ì‹¤í–‰ë¨");
    console.log("ì£¼ì†Œ:", address);
    console.log("ë°ì´í„°:", data);

    const iconUrl = `https://openweathermap.org/img/wn/${icon}@2x.png`;
    const resultElement = document.getElementById("search-result");

    if (!resultElement) {
        console.error("âŒ search-result ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ");
        return;
    }

    try {
        // JSON ë°ì´í„°ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì „ë‹¬
        const dataString = encodeURIComponent(JSON.stringify(data));

        resultElement.innerHTML = `
        <div>
          <div class="searchAddress">
            ${address}
            <button class="setLocation-btn" onclick="showSearchInfo()">ìœ„ì¹˜ ì„¤ì •</button>
          </div>
          <div>
            <div class="searchContainer">
              <div>${address}</div>
              <div>
                <img class="weather_icon" src="${iconUrl}"/>
                <div class="weather_status">${temp}Â°C</div>
                <button class="changLocation-btn" onclick="setLocation('${dataString}')">ìœ„ì¹˜ ë³€ê²½í•˜ê¸°</button>
              </div>
            </div>
          </div>
        </div>`;

        resultElement.style.display = "block";
    } catch (error) {
        console.error("ğŸš¨ JSON ë³€í™˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
    }
}


function showSearchInfo() {
    const searchContainers = document.querySelectorAll(".searchContainer");
    const searchAddress = document.querySelectorAll(".searchAddress");

    searchContainers.forEach(container => {
        container.style.display = "block"; // ëª¨ë“  ìš”ì†Œ ë³´ì´ê²Œ í•¨
    });

    searchAddress.forEach(container => {
        container.style.display = "none"; // ê¸°ì¡´ ì£¼ì†Œ ê²€ìƒ‰ ë¶€ë¶„ ìˆ¨ê¹€
    });
}

function setLocation(dataString) {
    if (!dataString || dataString === "undefined") {
        console.error("âŒ setLocation: dataStringì´ undefinedì…ë‹ˆë‹¤.");
        return;
    }

    try {
        const data = JSON.parse(decodeURIComponent(dataString));

        if (!data.weather || !data.weather.formatted_address) {
            console.error("âŒ setLocation: ì˜ëª»ëœ ë°ì´í„° êµ¬ì¡°ì…ë‹ˆë‹¤.");
            return;
        }

        let location = data.weather.formatted_address;


        // ğŸ”¥ sessionStorageì— ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        sessionStorage.setItem("savedLocation", location);

       closeSlideWeather();
    } catch (error) {
        console.error("ğŸš¨ JSON íŒŒì‹± ì˜¤ë¥˜:", error);
    }
}

function getCurrentLocationAndUpdateSession() {
  navigator.geolocation.getCurrentPosition(
    (position) => {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      console.log("ğŸ“Œ í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜´:", lat, lon);

      fetch(`/api/weather/?lat=${lat}&lon=${lon}`)
        .then((response) => response.json())
        .then((data) => {
          if (data.error) {
            console.error("âŒ í˜„ì¬ ìœ„ì¹˜ì˜ ë‚ ì”¨ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          } else {
            sessionStorage.setItem("savedLocation", data.weather.formatted_address); // ğŸ”¥ í˜„ì¬ ìœ„ì¹˜ ì €ì¥
            console.log(`âœ… í˜„ì¬ ìœ„ì¹˜ ì €ì¥ë¨: ${data.weather.formatted_address}`);

            displayWeather(data);
            suggestOutfit(data.outfit_recommendation);
           closeSlideWeather()
          }
        })
        .catch((error) => {
          console.error("âŒ í˜„ì¬ ìœ„ì¹˜ ë‚ ì”¨ ë¡œë“œ ì‹¤íŒ¨:", error);
        });
    },
    () => {
      alert("âŒ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
  );
}





</script>
