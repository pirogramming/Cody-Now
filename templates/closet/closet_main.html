{% extends "base.html" %}
{% block content %}
<h2>ë‚´ ì˜·ì¥</h2>

<div id="closet">
    <button id="toggle-showbookmark-btn">
        {% if show_bookmarked %} ëª¨ë“  ì˜· ë³´ê¸° {% else %} ë¶ë§ˆí¬í•œ ì˜·ë§Œ ë³´ê¸° {% endif %}
    </button>

    <!-- âœ… ì¹´í…Œê³ ë¦¬ í•„í„° (JSë¡œ ë™ì  ì¶”ê°€) -->
    <div class="category-filter" id="upload-history-category-filter">
        <button class="filter-btn active" data-category="all" onclick="filterByCategory('all')">ì „ì²´</button>
        <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì¶”ê°€ -->
    </div>

    <div id="outfit-list">
        {% for outfit in outfits %}
        <div class="outfit-card" id="outfit-{{ outfit.id }}" data-category="{{ outfit.category.id }}">
            <img src="{{ outfit.image.url }}" alt="Outfit Image" class="uniform-image" onclick="goToInputPage({{ outfit.id }})">
            <div class="buttons">
                <button onclick="toggleBookmark({{ outfit.id }})">
                    {% if outfit.bookmarked %} â˜… {% else %} â˜† {% endif %}
                </button>
                <button onclick="deleteOutfit({{ outfit.id }})">ì‚­ì œ</button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div id="add-clothes-container">
    <a href="{% url 'closet:upload_outfit' %}" class="add-clothes-button">ì˜·ì¥ ì±„ìš°ê¸°</a>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    console.log(" í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°");
    loadCategories();  // âœ… Djangoì—ì„œ ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
});

// âœ… Djangoì˜ `/usercategory/` APIì—ì„œ ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸°
function loadCategories() {
    console.log("ğŸ”„ Fetching categories...");

    fetch("/usercategory/", {
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(response => response.json())
    .then(data => {
        console.log("ğŸ“Œ ë°›ì€ ì¹´í…Œê³ ë¦¬ ë°ì´í„°:", data);

        if (!data.categories || data.categories.length === 0) {
            console.warn("ğŸš¨ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŒ.");
            return;
        }

        updateCategoryFilters(data.categories, "all");
    })
    .catch(error => console.error("ğŸš¨ ì¹´í…Œê³ ë¦¬ ë¡œë”© ì‹¤íŒ¨:", error));
}

// âœ… ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ë™ì  ì¶”ê°€)
function updateCategoryFilters(categories, activeCategory) {
    console.log("ğŸ“Œ ì—…ë°ì´íŠ¸í•  ì¹´í…Œê³ ë¦¬:", categories);

    const filterContainer = document.getElementById("upload-history-category-filter");
    if (!filterContainer) {
        console.error("ğŸš¨ í•„í„° ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ.");
        return;
    }

    filterContainer.innerHTML = '';  // ê¸°ì¡´ ë²„íŠ¼ ì´ˆê¸°í™”

    // âœ… 'ì „ì²´' ë²„íŠ¼ ì¶”ê°€
    const allButton = document.createElement("button");
    allButton.classList.add("filter-btn");
    allButton.dataset.category = "all";
    allButton.innerText = "ì „ì²´";
    if (activeCategory === "all") allButton.classList.add("active");

    allButton.addEventListener("click", function () {
        filterByCategory("all");
    });
    filterContainer.appendChild(allButton);

    // âœ… ì‚¬ìš©ì ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì¶”ê°€
    categories.forEach(category => {
        console.log("âœ… ì¶”ê°€ë˜ëŠ” ì¹´í…Œê³ ë¦¬ ë²„íŠ¼:", category);

        const button = document.createElement("button");
        button.classList.add("filter-btn");
        button.dataset.category = category.id;
        button.innerText = category.name;
        if (activeCategory === category.id.toString()) button.classList.add("active");

        button.addEventListener("click", function () {
            filterByCategory(category.id);
        });

        filterContainer.appendChild(button);
    });

    console.log("âœ… ëª¨ë“  ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì¶”ê°€ ì™„ë£Œ");
}

// âœ… ì¹´í…Œê³ ë¦¬ë³„ í•„í„°ë§
function filterByCategory(category) {
    
    document.querySelectorAll(".filter-btn").forEach(btn => {
        btn.classList.remove("active");
        if (btn.dataset.category === category.toString()) {
            btn.classList.add("active");
        }
    });

    document.querySelectorAll(".outfit-card").forEach(card => {
        if (category === "all" || card.dataset.category === category.toString()) {
            card.style.display = "block";
        } else {
            card.style.display = "none";
        }
    });
}

// âœ… ë¶ë§ˆí¬ ê¸°ëŠ¥
function toggleBookmark(outfitId) {
    fetch(`/bookmark/${outfitId}/`, {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        location.reload();
    })
    .catch(error => {
        console.error("Error:", error);
    });
}

// âœ… ì‚­ì œ ê¸°ëŠ¥
function deleteOutfit(outfitId) {
    if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        fetch(`/delete/${outfitId}/`, {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            document.getElementById(`outfit-${outfitId}`).remove();
        })
        .catch(error => {
            console.error("Error:", error);
        });
    }
}

// âœ… ë¶ë§ˆí¬ í•„í„° ë²„íŠ¼ ê¸°ëŠ¥
document.getElementById("toggle-showbookmark-btn").onclick = function() {
    const currentURL = new URL(window.location.href);
    if (currentURL.searchParams.get("bookmarked") === "true") {
        currentURL.searchParams.delete("bookmarked");
    } else {
        currentURL.searchParams.set("bookmarked", "true");
    }
    window.location.href = currentURL.toString();
};

// âœ… í˜ì´ì§€ ì´ë™
function goToInputPage(outfitId) {
    //window.location.href = `{% url 'closet:upload_outfit' %}?id=${outfitId}`;
    window.location.href = `/upload/${outfitId}/`;
}
</script>

<style>
.uniform-image {
    width: 200px;
    height: 200px;
    object-fit: cover;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.outfit-card { margin-bottom: 20px; }
.buttons { margin-top: 10px; }
.buttons button { margin-right: 5px; }

/* ì˜· ë” ì¶”ê°€í•˜ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
#add-clothes-container {
    margin-top: 30px;
    text-align: center;
}
.add-clothes-button {
    display: inline-block;
    padding: 10px 20px;
    background-color: #4CAF50;
    color: #fff;
    text-decoration: none;
    font-size: 16px;
    border-radius: 5px;
    transition: background-color 0.3s ease;
}
.add-clothes-button:hover {
    background-color: #45a049;
}
</style>

{% endblock %}